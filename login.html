<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="/taipingdiguo/css/style.css">
    <script src="/taipingdiguo/js/config.js"></script>
    <script src="/taipingdiguo/js/main.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <!-- ç½‘ç«™æ ‡é¢˜ï¼Œé€šè¿‡ JavaScript åŠ¨æ€æ›´æ–° -->
        <h1 id="login-title">ğŸ” å¤ªå¹³åœ°å›½</h1>
        <p class="subtitle" id="login-subtitle">ç¥äººå¼€ä¼š</p>
        
        <div class="login-box">
            <h2>è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            <p class="hint">ä½ çš„åå­—çš„å…¨æ‹¼</p>
            
            <!-- å¯†ç è¾“å…¥æ¡† -->
            <input type="password" 
                   id="passwordInput" 
                   placeholder="è¾“å…¥å¯†ç " 
                   autofocus
                   onkeypress="if(event.key==='Enter') checkPassword()">
            
            <button onclick="checkPassword()" class="btn-primary">
                è¿›å…¥ç½‘ç«™
            </button>
            
            <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="errorMessage" class="error-message"></div>
        </div>
        
        <!-- å…³äºæœ¬ç«™çš„å¿«é€Ÿé“¾æ¥ -->
        <p class="login-footer">
            <a href="/taipingdiguo/about.html">å…³äºæœ¬ç«™</a> | 
            <span>éœ€è¦å¯†ç ï¼Ÿè”ç³»ç®¡ç†å‘˜</span>
        </p>
    </div>

    <script>
    // ============================================
    // ç™»å½•é¡µé¢åŠŸèƒ½
    // ============================================
    
    // é¡µé¢åŠ è½½æ—¶ä» CONFIG æ›´æ–°æ ‡é¢˜
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof CONFIG !== 'undefined') {
            document.getElementById('login-title').textContent = `ğŸ” ${CONFIG.site.title}`;
            document.getElementById('login-subtitle').textContent = CONFIG.site.subtitle;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');
        
        // å¦‚æœå·²ç™»å½•ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è·³è½¬é¦–é¡µ
        if (access === 'granted' && expire && Date.now() < parseInt(expire)) {
            window.location.href = '/taipingdiguo/index.html';
        }
    });
    
    /**
     * ä»GitHubåŠ è½½å¯†ç æ–‡ä»¶
     */
    async function loadPasswords() {
        try {
            // ä» config.js è·å–å¯†ç æ–‡ä»¶åœ°å€ï¼Œå¦‚æœ CONFIG æœªå®šä¹‰åˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„
            const url = typeof CONFIG !== 'undefined' && CONFIG.passwords?.fileUrl
                ? CONFIG.passwords.fileUrl + '?t=' + Date.now()
                : 'https://raw.githubusercontent.com/zgnhit/taipingdiguo/main/data/passwords.json?t=' + Date.now();
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error('æ— æ³•åŠ è½½å¯†ç æ–‡ä»¶');
            }
            
            const data = await response.json();
            return data.valid_passwords.map(p => p.toLowerCase());
        } catch (error) {
            console.error('è¯»å–å¯†ç å¤±è´¥:', error);
            // å¤‡ç”¨å¯†ç 
            return ['game2024', 'renpyfan', 'test123'];
        }
    }
    
    /**
     * éªŒè¯ç”¨æˆ·è¾“å…¥çš„å¯†ç 
     */
    async function checkPassword() {
        const inputPwd = document.getElementById('passwordInput').value.trim().toLowerCase();
        const errorDiv = document.getElementById('errorMessage');
        
        // æ£€æŸ¥æ˜¯å¦è¾“å…¥ä¸ºç©º
        if (!inputPwd) {
            errorDiv.textContent = 'âŒ è¯·è¾“å…¥å¯†ç ';
            return;
        }
        
        // åŠ è½½æœ‰æ•ˆå¯†ç 
        const validPasswords = await loadPasswords();
        
        // éªŒè¯å¯†ç 
        if (validPasswords.includes(inputPwd)) {
            // å¯†ç æ­£ç¡®ï¼šè·å–æœ‰æ•ˆæœŸ
            const expireDays = typeof CONFIG !== 'undefined' && CONFIG.passwords?.expireDays 
                ? CONFIG.passwords.expireDays 
                : 7;
            
            const expireTime = Date.now() + expireDays * 24 * 60 * 60 * 1000;
            
            // ä¿å­˜ç™»å½•çŠ¶æ€
            localStorage.setItem('site_access', 'granted');
            localStorage.setItem('access_expire', expireTime);
            localStorage.setItem('login_time', new Date().toLocaleString());
            localStorage.setItem('login_code', inputPwd);  // ä¿å­˜ä½¿ç”¨çš„å¯†ç 
            
            // è·³è½¬åˆ°é¦–é¡µ
            window.location.href = '/taipingdiguo/index.html';
        } else {
            // å¯†ç é”™è¯¯
            errorDiv.textContent = 'âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }
    
    // æš´éœ²å…¨å±€å‡½æ•°ï¼ˆä¾› onclick è°ƒç”¨ï¼‰
    window.checkPassword = checkPassword;
    </script>
</body>
</html>
