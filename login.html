<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="/taipingdiguo/css/style.css">
    <!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
    <script src="/taipingdiguo/js/config.js"></script>
</head>
<body class="login-page">
<div class="login-container">
    <!-- ç½‘ç«™æ ‡é¢˜ï¼Œä»é…ç½®æ–‡ä»¶è¯»å– -->
    <h1>ğŸ” ${CONFIG.site.title}</h1>
    <p class="subtitle">${CONFIG.site.subtitle}</p>

    <div class="login-box">
        <h2>è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
        <p class="hint">å¯†ç å¯ä»¥åœ¨ data/passwords.json ä¸­ä¿®æ”¹</p>

        <!-- å¯†ç è¾“å…¥æ¡† -->
        <input type="password"
               id="passwordInput"
               placeholder="è¾“å…¥å¯†ç "
               autofocus
               onkeypress="if(event.key==='Enter') checkPassword()">

        <button onclick="checkPassword()" class="btn-primary">
            è¿›å…¥ç½‘ç«™
        </button>

        <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="errorMessage" class="error-message"></div>
    </div>

    <!-- å…³äºæœ¬ç«™çš„å¿«é€Ÿé“¾æ¥ -->
    <p class="login-footer">
        <a href="about.html">å…³äºæœ¬ç«™</a> |
        <span>éœ€è¦å¯†ç ï¼Ÿè”ç³»ç®¡ç†å‘˜</span>
    </p>
</div>

<script>
    // ============================================
    // ç™»å½•éªŒè¯åŠŸèƒ½
    // ============================================

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    (function() {
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');

        // å¦‚æœå·²ç™»å½•ä¸”æœªè¿‡æœŸï¼Œç›´æ¥è·³è½¬é¦–é¡µ
        if (access === 'granted' && expire && Date.now() < parseInt(expire)) {
            window.location.href = 'index.html';
        }
    })();

    /**
     * ä»GitHubåŠ è½½å¯†ç æ–‡ä»¶
     * ä» data/passwords.json è¯»å–æœ‰æ•ˆå¯†ç åˆ—è¡¨
     */
    async function loadPasswords() {
        try {
            // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
            const url = CONFIG.passwords.fileUrl + '?t=' + Date.now();
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error('æ— æ³•åŠ è½½å¯†ç æ–‡ä»¶');
            }

            const data = await response.json();
            // è¿”å›å¯†ç åˆ—è¡¨ï¼ˆè½¬ä¸ºå°å†™æ–¹ä¾¿æ¯”è¾ƒï¼‰
            return data.valid_passwords.map(p => p.toLowerCase());
        } catch (error) {
            console.error('è¯»å–å¯†ç å¤±è´¥:', error);
            // å¦‚æœç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å¯†ç ï¼ˆæ–¹ä¾¿å¼€å‘æµ‹è¯•ï¼‰
            return ['game2024', 'renpyfan', 'test123'];
        }
    }

    /**
     * éªŒè¯ç”¨æˆ·è¾“å…¥çš„å¯†ç 
     */
    async function checkPassword() {
        const inputPwd = document.getElementById('passwordInput').value.trim().toLowerCase();
        const errorDiv = document.getElementById('errorMessage');

        // æ£€æŸ¥æ˜¯å¦è¾“å…¥ä¸ºç©º
        if (!inputPwd) {
            errorDiv.textContent = 'âŒ è¯·è¾“å…¥å¯†ç ';
            return;
        }

        // åŠ è½½æœ‰æ•ˆå¯†ç 
        const validPasswords = await loadPasswords();

        // éªŒè¯å¯†ç 
        if (validPasswords.includes(inputPwd)) {
            // å¯†ç æ­£ç¡®ï¼šè®¡ç®—è¿‡æœŸæ—¶é—´
            const expireTime = Date.now() + CONFIG.passwords.expireDays * 24 * 60 * 60 * 1000;

            // ä¿å­˜ç™»å½•çŠ¶æ€
            localStorage.setItem('site_access', 'granted');
            localStorage.setItem('access_expire', expireTime);
            localStorage.setItem('login_time', new Date().toLocaleString());

            // è·³è½¬åˆ°é¦–é¡µ
            window.location.href = 'index.html';
        } else {
            // å¯†ç é”™è¯¯
            errorDiv.textContent = 'âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }
</script>
</body>

</html>

