<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="/taipingdiguo/css/style.css">
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
</head>
<body class="login-page">
    <div class="login-container">
        <h1 id="login-title">ğŸ” å¤ªå¹³åœ°å›½</h1>
        <p class="subtitle" id="login-subtitle">ç¥äººå¼€ä¼š</p>
        
        <div class="login-box">
            <h2>è¯·è¾“å…¥è®¿é—®å¯†ç </h2>
            <p class="hint">ä½ çš„åå­—çš„å…¨æ‹¼</p>
            
            <input type="password" 
                   id="passwordInput" 
                   placeholder="è¾“å…¥å¯†ç " 
                   autofocus
                   onkeypress="if(event.key==='Enter') checkPassword()">
            
            <button onclick="checkPassword()" class="btn-primary">
                è¿›å…¥ç½‘ç«™
            </button>
            
            <div id="errorMessage" class="error-message"></div>
        </div>
        
        <p class="login-footer">
            <a href="about.html">å…³äºæœ¬ç«™</a> | 
            <span>éœ€è¦å¯†ç ï¼Ÿè”ç³»å¤©ç‹</span>
        </p>
    </div>

    <script>
    // 1. é¡µé¢åŠ è½½æ›´æ–° UI
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof CONFIG !== 'undefined') {
            document.getElementById('login-title').textContent = `ğŸ” ${CONFIG.site.title}`;
            document.getElementById('login-subtitle').textContent = CONFIG.site.subtitle;
        }
        
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');
        if (access === 'granted' && expire && Date.now() < parseInt(expire)) {
            window.location.href = '/taipingdiguo/index.html';
        }
    });

    /**
     * ä» GitHub åŠ è½½å¯†ç æ–‡ä»¶
     */
    async function loadPasswords() {
        let url = '';
        

        if (typeof CONFIG !== 'undefined' && CONFIG.passwords && CONFIG.passwords.fileUrl) {
            url = CONFIG.passwords.fileUrl;
        } else {

            url = 'https://raw.githubusercontent.com/ZGNhit/taipingdiguo/main/data/passwords.json';
        }

        // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
        const finalUrl = url + '?t=' + Date.now();
        console.log("æ­£åœ¨å°è¯•è¯»å–å¯†ç æ–‡ä»¶:", finalUrl);

        try {
            const response = await fetch(finalUrl);
            if (!response.ok) throw new Error(`HTTP é”™è¯¯! çŠ¶æ€ç : ${response.status}`);
            
            const data = await response.json();
            // ç¡®ä¿è¯»å–åˆ°çš„æ˜¯ valid_passwords æ•°ç»„
            if (data && data.valid_passwords) {
                return data.valid_passwords.map(p => String(p).toLowerCase().trim());
            }
            return [];
        } catch (error) {
            console.error('è¯»å–å¯†ç æ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨ç´§æ€¥å¤‡ç”¨å¯†ç :', error);
            return ['tptg']; // åªæœ‰ç½‘ç»œæ–­å¼€æˆ– 404 æ‰ä¼šèµ°è¿™é‡Œ
        }
    }

    /**
     * éªŒè¯ç”¨æˆ·è¾“å…¥çš„å¯†ç 
     */
    async function checkPassword() {
        const inputPwd = document.getElementById('passwordInput').value.trim().toLowerCase();
        const errorDiv = document.getElementById('errorMessage');
        const btn = document.querySelector('.btn-primary');
        
        if (!inputPwd) {
            errorDiv.textContent = 'âŒ è¯·è¾“å…¥å¯†ç ';
            return;
        }

        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
        btn.disabled = true;
        btn.textContent = 'æ­£åœ¨éªŒè¯...';
        
        const validPasswords = await loadPasswords();
        
        if (validPasswords.includes(inputPwd)) {
            const expireDays = (typeof CONFIG !== 'undefined' && CONFIG.passwords?.expireDays) ? CONFIG.passwords.expireDays : 365;
            const expireTime = Date.now() + expireDays * 24 * 60 * 60 * 1000;
            
            localStorage.setItem('site_access', 'granted');
            localStorage.setItem('access_expire', expireTime);
            localStorage.setItem('login_code', inputPwd);
            
            window.location.href = 'index.html';
        } else {
            errorDiv.textContent = 'âŒ å¯†ç é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
            btn.disabled = false;
            btn.textContent = 'è¿›å…¥ç½‘ç«™';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }
    </script>
</body>
</html>

