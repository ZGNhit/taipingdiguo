<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/config.js"></script>
    <script src="js/marked.min.js"></script>
</head>
<body>
<!-- å¯¼èˆªæ ï¼ˆåŒä¸Šï¼‰ -->
<nav class="navbar">
    <!-- ... å’Œé¦–é¡µç›¸åŒçš„å¯¼èˆªæ  ... -->
</nav>

<main class="container">
    <!-- æ–‡ç« å†…å®¹å®¹å™¨ -->
    <article class="full-article" id="articleContent">
        <div class="loading">åŠ è½½æ–‡ç« ä¸­...</div>
    </article>

    <!-- è¯„è®ºåŒºï¼ˆåŸºäºGitHub Issuesï¼‰ -->
    <section class="comments-section">
        <h3>ğŸ“¢ è¯„è®ºåŒº</h3>
        <div id="comments">
            <!-- è¯„è®ºä¼šåŠ¨æ€åŠ è½½ -->
        </div>
    </section>
</main>

<script>
    // ============================================
    // æ–‡ç« è¯¦æƒ…é¡µåŠŸèƒ½
    // ============================================

    // ç™»å½•æ£€æŸ¥ï¼ˆåŒé¦–é¡µï¼‰
    (function() {
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');
        if (access !== 'granted' || !expire || Date.now() > parseInt(expire)) {
            localStorage.removeItem('site_access');
            localStorage.removeItem('access_expire');
            window.location.href = 'login.html';
        }
    })();

    // è·å–URLå‚æ•°ä¸­çš„æ–‡ç« ID
    const urlParams = new URLSearchParams(window.location.search);
    const articleId = urlParams.get('id');

    /**
     * åŠ è½½æ–‡ç« è¯¦æƒ…
     */
    async function loadArticle() {
        if (!articleId) {
            window.location.href = 'index.html';
            return;
        }

        const contentDiv = document.getElementById('articleContent');

        try {
            // è·å–æ–‡ç« è¯¦æƒ…
            const response = await fetch(
                `https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/issues/${articleId}`
            );

            if (!response.ok) {
                throw new Error('æ–‡ç« ä¸å­˜åœ¨');
            }

            const article = await response.json();

            // å°†Markdownå†…å®¹è½¬ä¸ºHTML
            const htmlContent = marked.parse(article.body);

            // æ¸²æŸ“æ–‡ç« 
            contentDiv.innerHTML = `
                <h1 class="article-title">${article.title}</h1>
                <div class="article-meta">
                    <span>ä½œè€…ï¼š${article.user.login}</span>
                    <span>å‘å¸ƒæ—¶é—´ï¼š${new Date(article.created_at).toLocaleString()}</span>
                    <span>æœ€åæ›´æ–°ï¼š${new Date(article.updated_at).toLocaleString()}</span>
                </div>
                <div class="article-body">
                    ${htmlContent}
                </div>
                <div class="article-actions">
                    <a href="index.html" class="btn-secondary">â† è¿”å›é¦–é¡µ</a>
                    <a href="submit.html" class="btn-primary">æˆ‘ä¹Ÿè¦æŠ•ç¨¿</a>
                </div>
            `;

            // åŠ è½½è¯„è®º
            loadComments(article.comments_url);

        } catch (error) {
            contentDiv.innerHTML = '<p class="error">æ–‡ç« åŠ è½½å¤±è´¥</p>';
        }
    }

    /**
     * åŠ è½½è¯„è®º
     */
    async function loadComments(commentsUrl) {
        const commentsDiv = document.getElementById('comments');

        try {
            const response = await fetch(commentsUrl);
            const comments = await response.json();

            if (comments.length === 0) {
                commentsDiv.innerHTML = '<p class="empty-message">æš‚æ— è¯„è®º</p>';
                return;
            }

            let html = '';
            comments.forEach(comment => {
                html += `
                    <div class="comment-item">
                        <div class="comment-header">
                            <img src="${comment.user.avatar_url}" class="comment-avatar" width="32" height="32">
                            <span class="comment-author">${comment.user.login}</span>
                            <span class="comment-time">${new Date(comment.created_at).toLocaleString()}</span>
                        </div>
                        <div class="comment-body">${marked.parse(comment.body)}</div>
                    </div>
                `;
            });

            commentsDiv.innerHTML = html;
        } catch (error) {
            commentsDiv.innerHTML = '<p class="error">è¯„è®ºåŠ è½½å¤±è´¥</p>';
        }
    }

    // é¡µé¢åŠ è½½
    loadArticle();
</script>
</body>
</html>