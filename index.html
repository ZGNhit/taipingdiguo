<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µ - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="/taipingdiguo/js/config.js"></script>
    <script src="/taipingdiguo/js/marked.min.js"></script>
</head>
<body>
<!-- ========== å¯¼èˆªæ  ========== -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="index.html">ğŸ® ${CONFIG.site.title}</a>
        </div>
        <div class="nav-menu">
            <a href="index.html" class="active">é¦–é¡µ</a>
            <a href="submit.html">æŠ•ç¨¿</a>
            ${CONFIG.about.showOnMenu ? '<a href="about.html">å…³äº</a>' : ''}
        </div>
        <div class="nav-user" id="userStatus">
            <!-- ç”¨æˆ·çŠ¶æ€ä¼šé€šè¿‡JSåŠ¨æ€æ˜¾ç¤º -->
        </div>
    </div>
</nav>

<!-- ========== ä¸»è¦å†…å®¹åŒºåŸŸ ========== -->
<main class="container">
    <!-- ç½‘ç«™æ ‡é¢˜åŒº -->
    <header class="page-header">
        <h1>${CONFIG.site.title}</h1>
        <p class="subtitle">${CONFIG.site.subtitle}</p>
    </header>

    <!-- ä¸¤åˆ—å¸ƒå±€ï¼šå·¦ä¾§æ–‡ç« åˆ—è¡¨ï¼Œå³ä¾§æ¸¸æˆå…¥å£ -->
    <div class="two-column">
        <!-- å·¦ä¾§ï¼šæ–‡ç« åˆ—è¡¨ -->
        <div class="main-content">
            <div class="section-header">
                <h2>ğŸ“ æœ€æ–°æ–‡ç« </h2>
                <a href="submit.html" class="btn-small">æˆ‘ä¹Ÿè¦æŠ•ç¨¿</a>
            </div>

            <!-- æ–‡ç« åˆ—è¡¨å®¹å™¨ -->
            <div id="articleList" class="article-list">
                <div class="loading">åŠ è½½æ–‡ç« ä¸­...</div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šä¾§è¾¹æ  -->
        <div class="sidebar">
            <!-- æ¸¸æˆå…¥å£åŒºåŸŸ -->
            <div class="sidebar-section">
                <h3>ğŸ® æˆ‘çš„æ¸¸æˆ</h3>
                <div id="gameList" class="game-list">
                    <!-- æ¸¸æˆåˆ—è¡¨ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ç½‘ç«™ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="sidebar-section">
                <h3>ğŸ“Š ç½‘ç«™ç»Ÿè®¡</h3>
                <div id="siteStats">
                    <p>æ–‡ç« æ€»æ•°: <span id="totalPosts">è®¡ç®—ä¸­...</span></p>
                    <p>ä¸Šçº¿å¤©æ•°: <span id="onlineDays">è®¡ç®—ä¸­...</span></p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- ========== é¡µè„š ========== -->
<footer class="footer">
    <div class="container">
        <p>${CONFIG.site.title} - ${CONFIG.site.description}</p>
        <p class="small">ç™»å½•æœ‰æ•ˆæœŸ ${CONFIG.passwords.expireDays} å¤© | å¯†ç åœ¨ data/passwords.json ç®¡ç†</p>
    </div>
</footer>

<script>
    // ============================================
    // é¦–é¡µåŠŸèƒ½ï¼šç™»å½•æ£€æŸ¥ã€åŠ è½½æ–‡ç« ã€åŠ è½½æ¸¸æˆ
    // ============================================

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    (function() {
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');

        // å¦‚æœæœªç™»å½•æˆ–å·²è¿‡æœŸï¼Œè·³å›ç™»å½•é¡µ
        if (access !== 'granted' || !expire || Date.now() > parseInt(expire)) {
            localStorage.removeItem('site_access');
            localStorage.removeItem('access_expire');
            window.location.href = 'login.html';
        }
    })();

    // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
    function updateUserStatus() {
        const loginTime = localStorage.getItem('login_time');
        const userDiv = document.getElementById('userStatus');

        if (loginTime) {
            userDiv.innerHTML = `
                <span class="user-badge">å·²ç™»å½•</span>
                <button onclick="logout()" class="btn-logout">é€€å‡º</button>
            `;
        }
    }

    // é€€å‡ºç™»å½•
    window.logout = function() {
        localStorage.removeItem('site_access');
        localStorage.removeItem('access_expire');
        localStorage.removeItem('login_time');
        window.location.href = 'login.html';
    };

    // ========== æ–‡ç« ç›¸å…³åŠŸèƒ½ ==========

    /**
     * ä»GitHubåŠ è½½æ‰€æœ‰æ–‡ç« 
     * æ–‡ç« å­˜å‚¨åœ¨ Issues ä¸­ï¼Œå¸¦æœ‰ 'post' æ ‡ç­¾
     */
    async function loadArticles() {
        const articleList = document.getElementById('articleList');

        try {
            // è°ƒç”¨ GitHub API è·å– Issues
            const response = await fetch(
                `https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/issues?labels=post&state=open&sort=created&direction=desc`
            );

            if (!response.ok) {
                throw new Error('åŠ è½½å¤±è´¥');
            }

            const articles = await response.json();

            if (articles.length === 0) {
                articleList.innerHTML = '<p class="empty-message">è¿˜æ²¡æœ‰æ–‡ç« ï¼Œå¿«æ¥<a href="submit.html">å‘å¸ƒç¬¬ä¸€ç¯‡</a>å§ï¼</p>';
                return;
            }

            // ç”Ÿæˆæ–‡ç« åˆ—è¡¨HTML
            let html = '';
            articles.forEach(article => {
                // ä»æ–‡ç« å†…å®¹ä¸­æå–ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºç¼©ç•¥å›¾
                const imageMatch = article.body.match(/!\[.*?\]\((.*?)\)/);
                const thumbnail = imageMatch ? imageMatch[1] : null;

                // æå–çº¯æ–‡æœ¬é¢„è§ˆï¼ˆå»æ‰Markdownå›¾ç‰‡è¯­æ³•ï¼‰
                const preview = article.body
                    .replace(/!\[.*?\]\(.*?\)/g, '')  // ç§»é™¤å›¾ç‰‡
                    .replace(/[#*`>]/g, '')          // ç§»é™¤Markdownç¬¦å·
                    .substring(0, 120) + '...';

                html += `
                    <div class="article-card" onclick="location.href='article.html?id=${article.number}'">
                        ${thumbnail ? `<div class="article-thumbnail"><img src="${thumbnail}" alt="ç¼©ç•¥å›¾"></div>` : ''}
                        <div class="article-info">
                            <h3><a href="article.html?id=${article.number}">${article.title}</a></h3>
                            <p class="article-preview">${preview}</p>
                            <div class="article-meta">
                                <span>ğŸ‘¤ ${article.user.login}</span>
                                <span>ğŸ“… ${new Date(article.created_at).toLocaleDateString()}</span>
                                <span>ğŸ’¬ ${article.comments} è¯„è®º</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            articleList.innerHTML = html;

            // æ›´æ–°æ–‡ç« æ€»æ•°ç»Ÿè®¡
            document.getElementById('totalPosts').textContent = articles.length;

        } catch (error) {
            console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
            articleList.innerHTML = '<p class="error-message">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
        }
    }

    // ========== æ¸¸æˆåˆ—è¡¨åŠŸèƒ½ ==========

    /**
     * ä»é…ç½®æ–‡ä»¶åŠ è½½æ¸¸æˆåˆ—è¡¨
     */
    function loadGames() {
        const gameList = document.getElementById('gameList');
        let html = '';

        // éå†é…ç½®ä¸­çš„æ¸¸æˆ
        CONFIG.games.forEach(game => {
            if (game.enabled) {
                html += `
                    <div class="game-card">
                        <div class="game-icon">${game.thumbnail}</div>
                        <div class="game-info">
                            <h4>${game.name}</h4>
                            <p class="game-description">${game.description}</p>
                            <a href="${game.url}" target="_blank" class="btn-play"
                               onclick="return confirm('å³å°†è·³è½¬åˆ° Itch.io ç©æ¸¸æˆï¼Œç¡®å®šå—ï¼Ÿ')">
                                å¼€å§‹æ¸¸æˆ
                            </a>
                        </div>
                    </div>
                `;
            }
        });

        gameList.innerHTML = html;
    }

    // ========== ç»Ÿè®¡åŠŸèƒ½ ==========

    /**
     * è®¡ç®—ç½‘ç«™ä¸Šçº¿å¤©æ•°
     * ä»ä»“åº“åˆ›å»ºæ—¶é—´ç®—èµ·
     */
    async function calculateOnlineDays() {
        try {
            const response = await fetch(
                `https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}`
            );
            const data = await response.json();

            const created = new Date(data.created_at);
            const today = new Date();
            const diffTime = Math.abs(today - created);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            document.getElementById('onlineDays').textContent = diffDays;
        } catch (error) {
            document.getElementById('onlineDays').textContent = '?';
        }
    }

    // ========== é¡µé¢åˆå§‹åŒ– ==========
    updateUserStatus();
    loadArticles();
    loadGames();
    calculateOnlineDays();

    // å®šæœŸæ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆæ¯”å¦‚é€€å‡ºæŒ‰é’®çš„çŠ¶æ€ï¼‰
    setInterval(updateUserStatus, 1000);
</script>
</body>

</html>

