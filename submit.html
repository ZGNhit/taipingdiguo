<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投稿 - 太平地国</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="/taipingdiguo/js/config.js"></script>
</head>
<body>
<!-- 导航栏（同首页） -->
<nav class="navbar">
    <!-- ... 和首页相同的导航栏 ... -->
</nav>

<main class="container">
    <div class="submit-container">
        <h1>✍️ 发布文章</h1>
        <p class="hint">分享你的贵物心得</p>

        <!-- 投稿表单 -->
        <form id="submitForm" onsubmit="return false;">
            <!-- 标题输入 -->
            <div class="form-group">
                <label for="title">文章标题 <span class="required">*</span></label>
                <input type="text"
                       id="title"
                       placeholder="给你的文章起个标题"
                       required
                       maxlength="100">
            </div>

            <!-- 内容输入 -->
            <div class="form-group">
                <label for="content">文章内容 <span class="required">*</span></label>
                <p class="field-hint">支持 Markdown 语法，可以用 ![](图片链接) 插入图片</p>
                <textarea id="content"
                          rows="15"
                          placeholder="在这里写你的文章..."
                          required></textarea>
            </div>

            <!-- 图片上传（直接存储到 GitHub） -->
            <div class="form-group">
                <label>上传图片到网站</label>
                <p class="field-hint">图片会直接存入网站仓库，获得链接后插入文章</p>

                <!-- 图片上传区域 -->
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" multiple>
                    <button type="button" onclick="uploadToGithub()" class="btn-secondary">
                        上传图片
                    </button>
                </div>

                <!-- 上传进度和结果 -->
                <div id="uploadProgress"></div>
                <div id="imageLinks" class="image-links"></div>
            </div>

            <!-- 提交按钮 -->
            <div class="form-actions">
                <button type="button" onclick="submitArticle()" class="btn-primary btn-large">
                    发布文章
                </button>
                <button type="button" onclick="previewArticle()" class="btn-secondary">
                    预览
                </button>
            </div>
        </form>

        <!-- 预览区域 -->
        <div id="previewArea" class="preview-area" style="display:none;">
            <h2>预览</h2>
            <div id="previewContent"></div>
        </div>
    </div>
</main>

<script src="/taipingdiguo/js/marked.min.js"></script>
<script>
    // ============================================
    // 投稿页面功能
    // ============================================

    // 登录检查
    (function() {
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');
        if (access !== 'granted' || !expire || Date.now() > parseInt(expire)) {
            localStorage.removeItem('site_access');
            localStorage.removeItem('access_expire');
            window.location.href = 'login.html';
        }
    })();

    // ========== 图片上传功能（直接存储到 GitHub） ==========

    /**
     * 上传图片到 GitHub 仓库
     * 需要 GitHub Token（和发布文章用同一个）
     */
    const GITHUB_TOKEN = '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';  // 你需要生成并填写

    /**
     * 将图片文件转为 Base64（去掉前缀）
     */
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                // 去掉 "data:image/jpeg;base64," 前缀，只保留 base64 内容
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = error => reject(error);
        });
    }

    /**
     * 生成安全的文件名（防止中文乱码和重复）
     * 格式：年月日_时分秒_随机数.扩展名
     */
    function generateFileName(originalName) {
        const date = new Date();
        const timestamp =
            date.getFullYear() +
            String(date.getMonth() + 1).padStart(2, '0') +
            String(date.getDate()).padStart(2, '0') + '_' +
            String(date.getHours()).padStart(2, '0') +
            String(date.getMinutes()).padStart(2, '0') +
            String(date.getSeconds()).padStart(2, '0');

        // 获取文件扩展名
        const ext = originalName.split('.').pop().toLowerCase();
        // 生成4位随机数防止完全重复
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');

        return `uploads/${timestamp}_${random}.${ext}`;
    }

    async function uploadToGithub() {
        const files = document.getElementById('imageInput').files;
        if (files.length === 0) {
            alert('请选择要上传的图片');
            return;
        }

        const progressDiv = document.getElementById('uploadProgress');
        const linksDiv = document.getElementById('imageLinks');

        progressDiv.innerHTML = '上传中...';
        linksDiv.innerHTML = '';

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // 检查文件大小（限制 100MB）
            if (file.size > 100 * 1024 * 1024) {
                progressDiv.innerHTML += `<br>❌ ${file.name} 超过100MB，跳过`;
                continue;
            }

            try {
                // 生成文件名
                const fileName = generateFileName(file.name);

                // 将文件转为 Base64
                const base64Content = await fileToBase64(file);

                // 上传到 GitHub
                const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `上传图片: ${file.name}`,
                        content: base64Content,
                        branch: 'main'  // 如果你的默认分支是 master，改成 'master'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // 构建图片的原始链接
                    const imageUrl = `https://raw.githubusercontent.com/${CONFIG.github.username}/${CONFIG.github.repo}/main/${fileName}`;

                    // 显示上传成功的链接
                    linksDiv.innerHTML += `
                        <div class="image-link-item">
                            <p>✅ ${file.name} 上传成功</p>
                            <input type="text" value="![${file.name}](${imageUrl})" readonly
                                   onclick="this.select()" class="link-input">
                            <button onclick="copyToClipboard('![${file.name}](${imageUrl})')">复制</button>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || '上传失败');
                }
            } catch (error) {
                progressDiv.innerHTML += `<br>❌ ${file.name} 上传失败: ${error.message}`;
            }
        }

        progressDiv.innerHTML += '<br>✅ 上传完成，复制上面的链接到文章内容中';
    }

    // 复制到剪贴板
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('已复制到剪贴板');
        });
    };

    // ========== 文章预览 ==========
    window.previewArticle = function() {
        const content = document.getElementById('content').value;
        const previewDiv = document.getElementById('previewArea');
        const previewContent = document.getElementById('previewContent');

        previewContent.innerHTML = marked.parse(content);
        previewDiv.style.display = 'block';
    };

    // ========== 提交文章到 GitHub ==========

    /**
     * 获取 GitHub Token
     * 你需要生成一个 Personal Access Token
     * 生成地址：https://github.com/settings/tokens
     * 需要权限：repo, issues
     */
    const GITHUB_TOKEN_FOR_ISSUES = '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';  // 你需要生成并填写

    window.submitArticle = async function() {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();

        // 验证输入
        if (!title) {
            alert('请输入标题');
            return;
        }
        if (!content) {
            alert('请输入内容');
            return;
        }

        // 获取登录密码（作为作者标识）
        const loginCode = localStorage.getItem('login_code') || 'unknown';

        // 准备文章内容
        const articleBody = content + `\n\n---\n*本文由密码用户 ${loginCode} 发布*`;

        try {
            // 创建 GitHub Issue
            const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/issues`, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN_FOR_ISSUES}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    body: articleBody,
                    labels: ['post']  // 标记为文章
                })
            });

            if (response.ok) {
                const issue = await response.json();
                alert('文章发布成功！');
                window.location.href = `article.html?id=${issue.number}`;
            } else {
                throw new Error('发布失败');
            }
        } catch (error) {
            console.error('发布失败:', error);
            alert('发布失败，请重试。如果问题持续，检查 GitHub Token 设置。');
        }
    };
</script>
</body>

</html>
