<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¨¿ - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="/taipingdiguo/css/style.css">
    <script src="/taipingdiguo/js/config.js"></script>
    <script src="/taipingdiguo/js/marked.min.js"></script>
    <script src="/taipingdiguo/js/main.js"></script>
</head>
<body>
<!-- å¯¼èˆªæ  -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="/taipingdiguo/index.html">ğŸ® å¤ªå¹³åœ°å›½</a>
        </div>
        <div class="nav-menu">
            <a href="/taipingdiguo/index.html">é¦–é¡µ</a>
            <a href="/taipingdiguo/submit.html" class="active">æŠ•ç¨¿</a>
            <a href="/taipingdiguo/about.html">å…³äº</a>
        </div>
        <div class="nav-user" id="userStatus"></div>
    </div>
</nav>

<main class="container">
    <div class="submit-container">
        <h1>âœï¸ å‘å¸ƒæ–‡ç« </h1>
        <p class="hint">åˆ†äº«ä½ çš„è´µç‰©å¿ƒå¾—</p>

        <!-- æŠ•ç¨¿è¡¨å• -->
        <form id="submitForm" onsubmit="return false;">
            <!-- æ ‡é¢˜è¾“å…¥ -->
            <div class="form-group">
                <label for="title">æ–‡ç« æ ‡é¢˜ <span class="required">*</span></label>
                <input type="text"
                       id="title"
                       placeholder="ç»™ä½ çš„æ–‡ç« èµ·ä¸ªæ ‡é¢˜"
                       required
                       maxlength="100">
            </div>

            <!-- å†…å®¹è¾“å…¥ -->
            <div class="form-group">
                <label for="content">æ–‡ç« å†…å®¹ <span class="required">*</span></label>
                <p class="field-hint">æ”¯æŒ Markdown è¯­æ³•ï¼Œå¯ä»¥ç”¨ ![](å›¾ç‰‡é“¾æ¥) æ’å…¥å›¾ç‰‡</p>
                <textarea id="content"
                          rows="15"
                          placeholder="åœ¨è¿™é‡Œå†™ä½ çš„æ–‡ç« ..."
                          required></textarea>
            </div>

            <!-- å›¾ç‰‡ä¸Šä¼  -->
            <div class="form-group">
                <label>ä¸Šä¼ å›¾ç‰‡åˆ°ç½‘ç«™</label>
                <p class="field-hint">å›¾ç‰‡ä¼šç›´æ¥å­˜å…¥ç½‘ç«™ä»“åº“ï¼Œè·å¾—é“¾æ¥åæ’å…¥æ–‡ç« </p>
                
                <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" multiple>
                    <button type="button" onclick="uploadToGithub()" class="btn-secondary">
                        ä¸Šä¼ å›¾ç‰‡
                    </button>
                </div>

                <!-- ä¸Šä¼ è¿›åº¦å’Œç»“æœ -->
                <div id="uploadProgress" class="upload-progress"></div>
                <div id="imageLinks" class="image-links"></div>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="form-actions">
                <button type="button" onclick="submitArticle()" class="btn-primary btn-large">
                    å‘å¸ƒæ–‡ç« 
                </button>
                <button type="button" onclick="previewArticle()" class="btn-secondary">
                    é¢„è§ˆ
                </button>
            </div>
        </form>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div id="previewArea" class="preview-area" style="display:none;">
            <h2>é¢„è§ˆ</h2>
            <div id="previewContent" class="preview-content"></div>
        </div>
    </div>
</main>

<!-- é¡µè„š -->
<footer class="footer">
    <div class="container">
        <p>å¤ªå¹³åœ°å›½ - åˆ†äº«æ¸¸æˆï¼Œåˆ†äº«å¿«ä¹</p>
    </div>
</footer>

<script>
    // ============================================
    // æŠ•ç¨¿é¡µé¢åŠŸèƒ½ - å®Œæ•´ä¿®å¤ç‰ˆ
    // ============================================

    // ---------- ç™»å½•æ£€æŸ¥ ----------
    (function() {
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');
        if (access !== 'granted' || !expire || Date.now() > parseInt(expire)) {
            localStorage.removeItem('site_access');
            localStorage.removeItem('access_expire');
            window.location.href = '/taipingdiguo/login.html';
        }
    })();

    // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
    function updateUserStatus() {
        const userDiv = document.getElementById('userStatus');
        if (!userDiv) return;
        
        const loginTime = localStorage.getItem('login_time');
        if (loginTime) {
            userDiv.innerHTML = `
                <span class="user-badge">å·²ç™»å½•</span>
                <button onclick="logout()" class="btn-logout">é€€å‡º</button>
            `;
        }
    }
    updateUserStatus();

    // é€€å‡ºç™»å½•å‡½æ•°
    window.logout = function() {
        localStorage.removeItem('site_access');
        localStorage.removeItem('access_expire');
        localStorage.removeItem('login_time');
        localStorage.removeItem('login_code');
        window.location.href = '/taipingdiguo/login.html';
    };

    // ---------- å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ----------
    // ä» localStorage è¯»å– tokenï¼ˆåªå£°æ˜ä¸€æ¬¡ï¼ï¼‰
    const GITHUB_TOKEN = localStorage.getItem('github_token') || '';

    /**
     * æ–‡ä»¶è½¬ Base64
     */
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                // å»æ‰ data:image/xxx;base64, å‰ç¼€
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = error => reject(error);
        });
    }

    /**
     * ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
     */
    function generateFileName(originalName) {
        const date = new Date();
        const timestamp = 
            date.getFullYear() + 
            String(date.getMonth() + 1).padStart(2, '0') + 
            String(date.getDate()).padStart(2, '0') + '_' +
            String(date.getHours()).padStart(2, '0') + 
            String(date.getMinutes()).padStart(2, '0') + 
            String(date.getSeconds()).padStart(2, '0');
        
        // è·å–æ–‡ä»¶æ‰©å±•å
        const ext = originalName.split('.').pop().toLowerCase();
        // ç”Ÿæˆ4ä½éšæœºæ•°
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        
        return `uploads/${timestamp}_${random}.${ext}`;
    }

    /**
     * ä¸Šä¼ å›¾ç‰‡åˆ° GitHub
     */
    window.uploadToGithub = async function() {
        const files = document.getElementById('imageInput').files;
        if (files.length === 0) {
            alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
            return;
        }

        // æ£€æŸ¥ token
        if (!GITHUB_TOKEN) {
            alert('è¯·å…ˆåœ¨æ§åˆ¶å°è®¾ç½® GitHub Tokenï¼š\nlocalStorage.setItem("github_token", "ä½ çš„token")');
            return;
        }

        const progressDiv = document.getElementById('uploadProgress');
        const linksDiv = document.getElementById('imageLinks');

        progressDiv.innerHTML = 'ğŸ”„ å‡†å¤‡ä¸Šä¼ ...';
        linksDiv.innerHTML = '';

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 100MBï¼‰
            if (file.size > 100 * 1024 * 1024) {
                progressDiv.innerHTML += `<br>âŒ ${file.name} è¶…è¿‡100MBï¼Œè·³è¿‡`;
                continue;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                progressDiv.innerHTML += `<br>âŒ ${file.name} ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œè·³è¿‡`;
                continue;
            }

            try {
                progressDiv.innerHTML += `<br>ğŸ”„ æ­£åœ¨ä¸Šä¼ : ${file.name}`;
                
                // ç”Ÿæˆæ–‡ä»¶å
                const fileName = generateFileName(file.name);
                
                // è½¬ä¸º Base64
                const base64Content = await fileToBase64(file);

                // ä¸Šä¼ åˆ° GitHub
                const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `ä¸Šä¼ å›¾ç‰‡: ${file.name}`,
                        content: base64Content,
                        branch: 'main'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // æ„å»ºå›¾ç‰‡çš„åŸå§‹é“¾æ¥
                    const imageUrl = `https://raw.githubusercontent.com/${CONFIG.github.username}/${CONFIG.github.repo}/main/${fileName}`;

                    // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸçš„é“¾æ¥
                    linksDiv.innerHTML += `
                        <div class="image-link-item">
                            <p>âœ… ${file.name} ä¸Šä¼ æˆåŠŸ</p>
                            <div style="display: flex; gap: 5px; margin: 5px 0;">
                                <input type="text" value="![${file.name}](${imageUrl})" readonly 
                                       onclick="this.select()" style="flex: 1; padding: 5px;">
                                <button onclick="copyToClipboard('![${file.name}](${imageUrl})')" style="padding: 5px 10px;">å¤åˆ¶</button>
                            </div>
                            <small style="color: #666;">ç‚¹å‡»è¾“å…¥æ¡†å¯å…¨é€‰ï¼Œç„¶åæŒ‰ Ctrl+C å¤åˆ¶</small>
                        </div>
                    `;
                    progressDiv.innerHTML += `<br>âœ… å®Œæˆ: ${file.name}`;
                } else {
                    throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                progressDiv.innerHTML += `<br>âŒ ${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`;
            }
        }

        progressDiv.innerHTML += '<br>ğŸ“‹ å¤åˆ¶ä¸Šé¢çš„é“¾æ¥åˆ°æ–‡ç« å†…å®¹ä¸­ï¼Œæ ¼å¼å¦‚ï¼š![](å›¾ç‰‡é“¾æ¥)';
    };

    // ---------- å¤åˆ¶åˆ°å‰ªè´´æ¿ ----------
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(() => {
            // å¤‡ç”¨æ–¹æ³•
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        });
    };

    // ---------- æ–‡ç« é¢„è§ˆ ----------
    window.previewArticle = function() {
        const content = document.getElementById('content').value.trim();
        if (!content) {
            alert('è¯·è¾“å…¥æ–‡ç« å†…å®¹');
            return;
        }

        const previewDiv = document.getElementById('previewArea');
        const previewContent = document.getElementById('previewContent');

        previewContent.innerHTML = marked.parse(content);
        previewDiv.style.display = 'block';
        
        // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
        previewDiv.scrollIntoView({ behavior: 'smooth' });
    };

    // ---------- æäº¤æ–‡ç« åˆ° GitHub ----------
    window.submitArticle = async function() {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();

        // éªŒè¯è¾“å…¥
        if (!title) {
            alert('è¯·è¾“å…¥æ ‡é¢˜');
            document.getElementById('title').focus();
            return;
        }
        if (!content) {
            alert('è¯·è¾“å…¥å†…å®¹');
            document.getElementById('content').focus();
            return;
        }

        // è·å– token
        const token = localStorage.getItem('github_token');
        if (!token) {
            alert('è¯·å…ˆè®¾ç½® GitHub Tokenï¼š\nåœ¨æ§åˆ¶å°æ‰§è¡Œ localStorage.setItem("github_token", "ä½ çš„token")');
            return;
        }

        // è·å–ç™»å½•å¯†ç ï¼ˆä½œä¸ºä½œè€…æ ‡è¯†ï¼‰
        const loginCode = localStorage.getItem('login_code') || 'unknown';

        // å‡†å¤‡æ–‡ç« å†…å®¹
        const articleBody = content + `\n\n---\n*æœ¬æ–‡ç”±å¯†ç ç”¨æˆ· ${loginCode} å‘å¸ƒäº ${new Date().toLocaleString()}*`;

        try {
            // æ˜¾ç¤ºå‘å¸ƒä¸­çŠ¶æ€
            const submitBtn = event.target;
            const originalText = submitBtn.innerText;
            submitBtn.innerText = 'å‘å¸ƒä¸­...';
            submitBtn.disabled = true;

            // åˆ›å»º GitHub Issue
            const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/issues`, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    body: articleBody,
                    labels: ['post']  // æ ‡è®°ä¸ºæ–‡ç« 
                })
            });

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;

            if (response.ok) {
                const issue = await response.json();
                alert('âœ… æ–‡ç« å‘å¸ƒæˆåŠŸï¼');
                // è·³è½¬åˆ°æ–°å‘å¸ƒçš„æ–‡ç« é¡µé¢
                window.location.href = `/taipingdiguo/article.html?id=${issue.number}`;
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || 'å‘å¸ƒå¤±è´¥');
            }
        } catch (error) {
            console.error('å‘å¸ƒå¤±è´¥:', error);
            alert(`âŒ å‘å¸ƒå¤±è´¥: ${error.message}\nè¯·æ£€æŸ¥ GitHub Token æ˜¯å¦æœ‰ issues æƒé™ã€‚`);
        }
    };

    // æ·»åŠ æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        uploadArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            document.getElementById('imageInput').files = files;
            uploadToGithub();
        });
    }
</script>

<!-- æ·»åŠ ä¸€äº›é¢å¤–çš„æ ·å¼ -->
<style>
    .upload-progress {
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        font-size: 14px;
    }
    .image-link-item {
        background: #f8f9fa;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        border-left: 4px solid #667eea;
    }
    .btn-logout {
        background: none;
        border: 1px solid #ddd;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
    }
    .btn-logout:hover {
        background: #f0f0f0;
    }
    .user-badge {
        background: #667eea;
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        margin-right: 10px;
    }
    .preview-content {
        padding: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-top: 10px;
    }
    .preview-content img {
        max-width: 100%;
    }
</style>
</body>
</html>
