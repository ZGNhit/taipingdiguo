<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¨¿ - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="/taipingdiguo/css/style.css">
    <script src="/taipingdiguo/js/config.js"></script>
    <script src="/taipingdiguo/js/marked.min.js"></script>
    <script src="/taipingdiguo/js/main.js"></script>
</head>
<body>
<!-- å¯¼èˆªæ  -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="/taipingdiguo/index.html">ğŸ® å¤ªå¹³åœ°å›½</a>
        </div>
        <div class="nav-menu">
            <a href="/taipingdiguo/index.html">é¦–é¡µ</a>
            <a href="/taipingdiguo/submit.html" class="active">æŠ•ç¨¿</a>
            <a href="/taipingdiguo/about.html">å…³äº</a>
        </div>
        <div class="nav-user" id="userStatus"></div>
    </div>
</nav>

<main class="container">
    <div class="submit-container">
        <h1>âœï¸ å‘å¸ƒæ–‡ç« </h1>
        <p class="hint">åˆ†äº«ä½ çš„è´µç‰©å¿ƒå¾—</p>

        <!-- æŠ•ç¨¿è¡¨å• -->
        <form id="submitForm" onsubmit="return false;">
            <div class="form-group">
                <label for="title">æ–‡ç« æ ‡é¢˜ <span class="required">*</span></label>
                <input type="text" id="title" placeholder="ç»™ä½ çš„æ–‡ç« èµ·ä¸ªæ ‡é¢˜" required maxlength="100">
            </div>

            <div class="form-group">
                <label for="content">æ–‡ç« å†…å®¹ <span class="required">*</span></label>
                <p class="field-hint">æ”¯æŒ Markdown è¯­æ³•ï¼Œå¯ä»¥ç”¨ ![](å›¾ç‰‡é“¾æ¥) æ’å…¥å›¾ç‰‡</p>
                <textarea id="content" rows="15" placeholder="åœ¨è¿™é‡Œå†™ä½ çš„æ–‡ç« ..." required></textarea>
            </div>

            <!-- å›¾ç‰‡ä¸Šä¼  -->
            <div class="form-group">
                <label>ä¸Šä¼ å›¾ç‰‡åˆ°ç½‘ç«™</label>
                <p class="field-hint">å›¾ç‰‡ä¼šç›´æ¥å­˜å…¥ç½‘ç«™ä»“åº“ï¼Œè·å¾—é“¾æ¥åæ’å…¥æ–‡ç« </p>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" multiple>
                    <button type="button" onclick="uploadToGithub()" class="btn-secondary">ä¸Šä¼ å›¾ç‰‡</button>
                </div>
                <div id="uploadProgress"></div>
                <div id="imageLinks" class="image-links"></div>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="form-actions">
                <button type="button" onclick="submitArticle()" class="btn-primary btn-large">å‘å¸ƒæ–‡ç« </button>
                <button type="button" onclick="previewArticle()" class="btn-secondary">é¢„è§ˆ</button>
            </div>
        </form>

        <!-- é¢„è§ˆåŒºåŸŸ -->
        <div id="previewArea" class="preview-area" style="display:none;">
            <h2>é¢„è§ˆ</h2>
            <div id="previewContent"></div>
        </div>
    </div>
</main>

<script>
    // ============================================
    // æŠ•ç¨¿é¡µé¢åŠŸèƒ½ - åªä¿ç•™å¿…è¦çš„å‡½æ•°
    // ============================================

    // ç™»å½•æ£€æŸ¥
    (function() {
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');
        if (access !== 'granted' || !expire || Date.now() > parseInt(expire)) {
            localStorage.removeItem('site_access');
            localStorage.removeItem('access_expire');
            window.location.href = '/taipingdiguo/login.html';
        }
    })();

    // ========== å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ==========
    const GITHUB_TOKEN = localStorage.getItem('github_token') || '';  // åªä¿ç•™è¿™ä¸€ä¸ªå£°æ˜

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = error => reject(error);
        });
    }

    function generateFileName(originalName) {
        const date = new Date();
        const timestamp = date.getFullYear() + 
            String(date.getMonth() + 1).padStart(2, '0') + 
            String(date.getDate()).padStart(2, '0') + '_' +
            String(date.getHours()).padStart(2, '0') + 
            String(date.getMinutes()).padStart(2, '0') + 
            String(date.getSeconds()).padStart(2, '0');
        const ext = originalName.split('.').pop().toLowerCase();
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return `uploads/${timestamp}_${random}.${ext}`;
    }

    window.uploadToGithub = async function() {
        const files = document.getElementById('imageInput').files;
        if (files.length === 0) {
            alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
            return;
        }

        if (!GITHUB_TOKEN) {
            alert('è¯·å…ˆåœ¨æ§åˆ¶å°è®¾ç½® GitHub Tokenï¼šlocalStorage.setItem("github_token", "ä½ çš„token")');
            return;
        }

        const progressDiv = document.getElementById('uploadProgress');
        const linksDiv = document.getElementById('imageLinks');
        progressDiv.innerHTML = 'ä¸Šä¼ ä¸­...';
        linksDiv.innerHTML = '';

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.size > 100 * 1024 * 1024) {
                progressDiv.innerHTML += `<br>âŒ ${file.name} è¶…è¿‡100MBï¼Œè·³è¿‡`;
                continue;
            }

            try {
                const fileName = generateFileName(file.name);
                const base64Content = await fileToBase64(file);
                
                const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `ä¸Šä¼ å›¾ç‰‡: ${file.name}`,
                        content: base64Content,
                        branch: 'main'
                    })
                });

                if (response.ok) {
                    const imageUrl = `https://raw.githubusercontent.com/${CONFIG.github.username}/${CONFIG.github.repo}/main/${fileName}`;
                    linksDiv.innerHTML += `
                        <div class="image-link-item">
                            <p>âœ… ${file.name} ä¸Šä¼ æˆåŠŸ</p>
                            <input type="text" value="![${file.name}](${imageUrl})" readonly onclick="this.select()" style="width:100%; padding:5px;">
                            <button onclick="copyToClipboard('![${file.name}](${imageUrl})')">å¤åˆ¶</button>
                        </div>
                    `;
                } else {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                progressDiv.innerHTML += `<br>âŒ ${file.name} ä¸Šä¼ å¤±è´¥`;
            }
        }
        progressDiv.innerHTML += '<br>âœ… ä¸Šä¼ å®Œæˆï¼Œå¤åˆ¶ä¸Šé¢çš„é“¾æ¥åˆ°æ–‡ç« å†…å®¹ä¸­';
    };

    // ========== å¤åˆ¶åˆ°å‰ªè´´æ¿ ==========
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
    };

    // ========== æ–‡ç« é¢„è§ˆ ==========
    window.previewArticle = function() {
        const content = document.getElementById('content').value;
        document.getElementById('previewContent').innerHTML = marked.parse(content);
        document.getElementById('previewArea').style.display = 'block';
    };

    // ========== æäº¤æ–‡ç«  ==========
    window.submitArticle = async function() {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();

        if (!title || !content) {
            alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
            return;
        }

        const token = localStorage.getItem('github_token');
        if (!token) {
            alert('è¯·å…ˆè®¾ç½® GitHub Token');
            return;
        }

        const loginCode = localStorage.getItem('login_code') || 'unknown';
        const articleBody = content + `\n\n---\n*æœ¬æ–‡ç”±å¯†ç ç”¨æˆ· ${loginCode} å‘å¸ƒäº ${new Date().toLocaleString()}*`;

        try {
            const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/issues`, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    body: articleBody,
                    labels: ['post']
                })
            });

            if (response.ok) {
                const issue = await response.json();
                alert('æ–‡ç« å‘å¸ƒæˆåŠŸï¼');
                window.location.href = `/taipingdiguo/article.html?id=${issue.number}`;
            } else {
                throw new Error('å‘å¸ƒå¤±è´¥');
            }
        } catch (error) {
            alert('å‘å¸ƒå¤±è´¥ï¼š' + error.message);
        }
    };
</script>
</body>
</html>
