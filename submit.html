<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¨¿ - å¤ªå¹³åœ°å›½</title>
    <link rel="stylesheet" href="/taipingdiguo/css/style.css">
    <script src="/taipingdiguo/js/config.js"></script>
    <script src="/taipingdiguo/js/marked.min.js"></script>
    <script src="/taipingdiguo/js/main.js"></script>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="/taipingdiguo/index.html">ğŸ® å¤ªå¹³åœ°å›½</a>
        </div>
        <div class="nav-menu">
            <a href="/taipingdiguo/index.html">é¦–é¡µ</a>
            <a href="/taipingdiguo/submit.html" class="active">æŠ•ç¨¿</a>
            <a href="/taipingdiguo/about.html">å…³äº</a>
        </div>
        <div class="nav-user" id="userStatus"></div>
    </div>
</nav>

<main class="container">
    <div class="submit-container">
        <h1>âœï¸ å‘å¸ƒæ–‡ç« </h1>
        <p class="hint">åˆ†äº«ä½ çš„è´µç‰©å¿ƒå¾—</p>

        <form id="submitForm" onsubmit="return false;">
            <div class="form-group">
                <label for="title">æ–‡ç« æ ‡é¢˜ <span class="required">*</span></label>
                <input type="text"
                       id="title"
                       placeholder="ç»™ä½ çš„æ–‡ç« èµ·ä¸ªæ ‡é¢˜"
                       required
                       maxlength="100">
            </div>

            <div class="form-group">
                <label for="content">æ–‡ç« å†…å®¹ <span class="required">*</span></label>
                <p class="field-hint">æ”¯æŒ Markdown è¯­æ³•ï¼Œå¯ä»¥ç”¨ ![](å›¾ç‰‡é“¾æ¥) æ’å…¥å›¾ç‰‡</p>
                <textarea id="content"
                          rows="15"
                          placeholder="åœ¨è¿™é‡Œå†™ä½ çš„æ–‡ç« ..."
                          required></textarea>
            </div>

            <div class="form-group">
                <label>ä¸Šä¼ å›¾ç‰‡åˆ°ç½‘ç«™</label>
                <p class="field-hint">å›¾ç‰‡ä¼šç›´æ¥å­˜å…¥ç½‘ç«™ä»“åº“ï¼Œè·å¾—é“¾æ¥åæ’å…¥æ–‡ç« </p>
                
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" multiple>
                    <button type="button" onclick="uploadToGithub()" class="btn-secondary">
                        ä¸Šä¼ å›¾ç‰‡
                    </button>
                </div>

                <div id="uploadProgress" class="upload-progress"></div>
                <div id="imageLinks" class="image-links"></div>
            </div>

            <div class="form-actions">
                <button type="button" onclick="submitArticle(event)" class="btn-primary btn-large">
                    å‘å¸ƒæ–‡ç« 
                </button>
                <button type="button" onclick="previewArticle()" class="btn-secondary">
                    é¢„è§ˆ
                </button>
            </div>
        </form>

        <div id="previewArea" class="preview-area" style="display:none;">
            <h2>é¢„è§ˆ</h2>
            <div id="previewContent" class="preview-content"></div>
        </div>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <p>å¤ªå¹³åœ°å›½ - åˆ†äº«æ¸¸æˆï¼Œåˆ†äº«å¿«ä¹</p>
    </div>
</footer>

<script>
    // ============================================
    // æŠ•ç¨¿é¡µé¢åŠŸèƒ½ - ä¿®å¤ç‰ˆ
    // ============================================

    // 1. ç™»å½•æ£€æŸ¥ï¼šåªä¿ç•™é€»è¾‘ï¼Œä¸é‡å¤å®šä¹‰å…¨å±€å˜é‡
    (function() {
        const access = localStorage.getItem('site_access');
        const expire = localStorage.getItem('access_expire');
        if (access !== 'granted' || !expire || Date.now() > parseInt(expire)) {
            window.location.href = '/taipingdiguo/login.html';
        }
    })();

    // 2. åŠ¨æ€è·å– Tokenï¼šè§£å†³ SyntaxError (Identifier already declared)
    // ä¸å†ä½¿ç”¨ const GITHUB_TOKENï¼Œè€Œæ˜¯é€šè¿‡å‡½æ•°åŠ¨æ€è·å–
    function getValidToken() {
        return window.GITHUB_TOKEN || localStorage.getItem('github_token') || '';
    }

    // 3. å›¾ç‰‡å¤„ç†é€»è¾‘
    async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });
    }

    function generateFileName(originalName) {
        const date = new Date();
        const timestamp = date.getFullYear() + 
            String(date.getMonth() + 1).padStart(2, '0') + 
            String(date.getDate()).padStart(2, '0') + '_' +
            String(date.getHours()).padStart(2, '0') + 
            String(date.getMinutes()).padStart(2, '0');
        const ext = originalName.split('.').pop().toLowerCase();
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return `uploads/${timestamp}_${random}.${ext}`;
    }

    // 4. å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
    window.uploadToGithub = async function() {
        const files = document.getElementById('imageInput').files;
        const token = getValidToken();
        if (files.length === 0) return alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å›¾ç‰‡');
        if (!token) return alert('è¯·å…ˆè®¾ç½® Token');

        const progressDiv = document.getElementById('uploadProgress');
        const linksDiv = document.getElementById('imageLinks');
        progressDiv.innerHTML = 'ğŸ”„ å‡†å¤‡ä¸Šä¼ ...';

        for (let file of files) {
            try {
                progressDiv.innerHTML += `<br>ğŸ”„ æ­£åœ¨ä¸Šä¼ : ${file.name}`;
                const fileName = generateFileName(file.name);
                const base64Content = await fileToBase64(file);

                const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/contents/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `ä¸Šä¼ å›¾ç‰‡: ${file.name}`,
                        content: base64Content,
                        branch: 'main'
                    })
                });

                if (response.ok) {
                    const imageUrl = `https://raw.githubusercontent.com/${CONFIG.github.username}/${CONFIG.github.repo}/main/${fileName}`;
                    linksDiv.innerHTML += `
                        <div class="image-link-item">
                            <p>âœ… ${file.name} æˆåŠŸ</p>
                            <input type="text" value="![img](${imageUrl})" readonly onclick="this.select()" style="width:80%;">
                            <button onclick="navigator.clipboard.writeText('![img](${imageUrl})').then(()=>alert('å·²å¤åˆ¶'))">å¤åˆ¶</button>
                        </div>`;
                }
            } catch (error) {
                progressDiv.innerHTML += `<br>âŒ ${file.name} å¤±è´¥: ${error.message}`;
            }
        }
    };

    // 5. é¢„è§ˆé€»è¾‘
    window.previewArticle = function() {
        const content = document.getElementById('content').value.trim();
        if (!content) return alert('è¯·è¾“å…¥å†…å®¹');
        document.getElementById('previewContent').innerHTML = marked.parse(content);
        document.getElementById('previewArea').style.display = 'block';
        document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });
    };

    // 6. å‘å¸ƒæ–‡ç« ï¼šè§£å†³ Post 404 ä¸ ReferenceError
    window.submitArticle = async function(event) {
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        const token = getValidToken();

        if (!title || !content) return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
        if (!token) return alert('æœªæ£€æµ‹åˆ° Token');

        const submitBtn = event.target;
        const originalText = submitBtn.innerText;
        submitBtn.innerText = 'å‘å¸ƒä¸­...';
        submitBtn.disabled = true;

        try {
            // æ³¨æ„ï¼šAPI è·¯å¾„å¿…é¡»åŒ¹é… CONFIG é‡Œçš„é…ç½®
            const response = await fetch(`https://api.github.com/repos/${CONFIG.github.username}/${CONFIG.github.repo}/issues`, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: title,
                    body: content + `\n\n---\n*By: ${localStorage.getItem('login_code') || 'ç”¨æˆ·'}*`,
                    labels: ['post']
                })
            });

            if (response.ok) {
                const issue = await response.json();
                alert('âœ… å‘å¸ƒæˆåŠŸï¼');
                window.location.href = `/taipingdiguo/article.html?id=${issue.number}`;
            } else {
                const errorData = await response.json();
                // å¦‚æœè¿”å› 404ï¼Œæå¤§æ¦‚ç‡æ˜¯ä»“åº“æ²¡å¼€ Issues
                if (response.status === 404) {
                    alert('âŒ å‘å¸ƒå¤±è´¥ (404)\nè¯·ç¡®è®¤ï¼š\n1. ä»“åº“å·²åœ¨ Settings -> Features å¼€å¯ Issues\n2. config.js é‡Œçš„ä»“åº“åæ­£ç¡®');
                } else {
                    alert(`âŒ é”™è¯¯: ${errorData.message}`);
                }
            }
        } catch (error) {
            alert(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
        } finally {
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;
        }
    };

    // 7. æ‹–æ‹½æ”¯æŒ
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', e => e.preventDefault());
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            document.getElementById('imageInput').files = e.dataTransfer.files;
            uploadToGithub();
        });
    }
</script>

<style>
    .upload-progress { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; }
    .image-link-item { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #667eea; }
    .user-badge { background: #667eea; color: white; padding: 5px 10px; border-radius: 3px; margin-right: 10px; }
    .preview-content { padding: 20px; background: white; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; }
    .preview-content img { max-width: 100%; }
</style>
</body>
</html>
